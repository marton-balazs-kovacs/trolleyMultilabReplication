---
title: "supplementary_materials"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{supplementary_materials}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# Load packages
library(trolleyMultilabReplication)
library(tidyverse)
library(countrycode)

# Prepare datafiles for the analysis
# Save data for each study separately
study1a <- filter(trolley, include_study1a)
study1b <- filter(trolley, include_study1b)
study2a <- filter(trolley, include_study2a)
study2b <- filter(trolley, include_study2b)

# Save data but wihtouth the familiarity filter for each study
study1a_nf <- filter(trolley, include_study1a_withoutfamiliarity)
study1b_nf <- filter(trolley, include_study1b_withoutfamiliarity)
study2a_nf <- filter(trolley, include_study2a_withoutfamiliarity)
study2b_nf <- filter(trolley, include_study2b_withoutfamiliarity)
```

```{r background information, echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
# Calculate background information
# Check if GBR001 is in the processed data
trolley %>% 
  distinct(survey_name, lab)

# Show the labs who are in the raw dataset but not in the processed
# Most likely these labs sent out the survey with the practice link
missing_labs <-
 trolley_raw %>%
 distinct(lab) %>%
 anti_join(., distinct(trolley_proc, lab), by = "lab")

# Show the number of participants missing in each lab
trolley_raw %>%
 inner_join(., missing_labs, by = "lab") %>%
 count(lab) %>%
 ungroup() %>%
 mutate(all_n = sum(n))

# Show the number of participants excluded because of not finished responses
trolley_raw %>%
 filter(str_detect(str_to_lower(practice), "false")) %>%
 filter(!(lab == "TUR_021" & StartDate < date("2020-04-22")),
        !(lab == "AUT_003" & StartDate < date("2020-06-18")),
        !(lab == "USA_095")) %>%
 filter(Progress < 98) %>%
 count()

# Show the number of labs
trolley %>% 
  distinct(lab) %>% 
  count()

trolley_raw %>% 
  distinct(lab) %>% 
  count()

# Number of responses
nrow(trolley)
nrow(trolley_raw)

# Number of languages
trolley_raw %>% 
  distinct(Q_Lang) %>% 
  drop_na(Q_Lang) %>% 
  count()
```

# 1. Demographics and exclusion 

```{r dem2,echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
summaries <-
  trolley %>% 
  nest(data = everything()) %>% 
  mutate(country_sum = map(data, 
                             ~group_by(.x, Region, country3) %>% 
                             summarise_study() %>% 
                             left_join(cd, by = "country3") %>% 
                             add_column(grouping = "By country", .before = 1) %>% 
                             mutate(Country = countrycode(sourcevar = country3, 
                                                          origin = "iso3c",
                                                          destination = "country.name")) %>% 
                             arrange(Region, Country)),
         region_sum = map(data, ~group_by(.x, Region) %>% 
                            summarise_study() %>% 
                            add_column(grouping = "By region", .before = 1) %>% 
                            arrange(Region)),
         all_sum =map(data, ~summarise_study(.x) %>% 
                        add_column(grouping = "All", .before = 1) %>% 
                        mutate(Region = "All")),
         # Add the 3 level summaries into one dateset
         bind_sum = pmap(list(country_sum, region_sum, all_sum), bind_rows))

demo_table <-
  summaries %>% 
  select(bind_sum) %>% 
  unnest(bind_sum) %>% 
  relocate(Country, .before = country3) %>% 
  select(-country3, -distance_year) %>% 
  gt(groupname_col = "grouping", 
     rowname_col = "Region") %>%
  fmt_number(columns = vars(`Age Mean`, `Age SD`),
             decimals = 1) %>% 
  cols_merge(columns = vars(`Age Mean`, `Age SD`), 
             pattern = "{1} ({2})") %>% 
  fmt_number(columns = vars(Collectivism),
             decimals = 3) %>% 
  fmt_percent(columns = vars(`Male %`, `Higher education %`),
              decimals = 1) %>% 
  fmt_missing(vars(Country, Collectivism, 
                   Region, grouping, `Higher education %`, 
                   `Male %`, `Age SD`)) %>% 
  cols_label(`Age Mean` = "Age (SD)") %>% 
  tab_footnote(footnote = "Distance from the US in collectivism. Some countries do not have a collectivism score.",
               locations = cells_column_labels(columns = vars(Collectivism))) %>% 
  tab_options(row.striping.include_table_body = TRUE,
              row.striping.background_color = "#EEEEEE", 
              row.striping.include_stub = TRUE,
              row_group.background.color = "#999999", 
              column_labels.background.color = "#999999")

demo_table
```

# 2. Additional analysis
## Effect of physical contact and intention

In every cluster and for both types of dilemma we found good enough evidence supporting the alternative hypothesis when testing the effect of physical contact and the effect of intention. The summary of the results can be found in the tables below.

```{r physical contact , echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
# Comparing standard footbridge with footbridge pole in every cluster
additional_trolley <- 
  trolley %>% 
  filter(include_study1a | include_study2a) %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_1", "trolley_4") ~ "trolley_physical",
                                task %in% c("trolley_3", "trolley_2") ~ "trolley_intention",
                                TRUE ~ NA_character_)) %>% 
  calculate_additional_table(.)

additional_speeedboat <- 
  trolley %>% 
  filter(include_study1b | include_study2b) %>% 
  select(survey_name, survey_id, matches("speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("speedboat_1", "speedboat_4") ~ "speedboat_physical",
                                task %in% c("speedboat_3", "speedboat_2") ~ "speedboat_intention",
                                TRUE ~ NA_character_)) %>% 
  calculate_additional_table(.)

bind_rows(additional_trolley, additional_speeedboat) %>% 
  filter(str_detect(comparison, "intention|physical")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            Comparison = case_when(Comparison == "physical" ~ "Physical Contact",
                                   Comparison == "intention" ~ "Intention"),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Effect of Physical Contact and Intention",
    escape = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Additional analysis after all exclusions
additional_res_1_excluded <- 
  trolley %>%
  filter(include_study1a | include_study1b | include_study2a | include_study2b) %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_1", "trolley_4") ~ "trolley_physical",
                                task %in% c("speedboat_1", "speedboat_4") ~ "speedboat_physical",
                                task %in% c("trolley_3", "trolley_2") ~ "trolley_intention",
                                task %in% c("speedboat_3", "speedboat_2") ~ "speedboat_intention",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_1_excluded %>% 
  filter(str_detect(comparison, "intention|physical")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            Comparison = case_when(Comparison == "physical" ~ "Physical Contact",
                                   Comparison == "intention" ~ "Intention"),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Effect of Physical Contact and Intention",
    escape = TRUE)
```

## Comparing the standard switch and standard footbridge dilemmas

When comparing the standard switch and standard footbridge dilemmas in all clusters for the trolley and the speedboat tasks we found good enough evidence in every case for the support of the alternative hypothesis. The summary results of each comparison separately can be found in Tables below.

```{r, standard switch and footbridge, echo = FALSE, message = FALSE, warning = FALSE, paged.print = FALSE}
additional_res_2 <- 
  trolley_proc %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_3", "trolley_4") ~ "trolley_standard",
                                task %in% c("speedboat_3", "speedboat_4") ~ "speedboat_standard",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_2 %>% 
  filter(str_detect(comparison, "standard")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Comparing the Standard Switch and Standard Footbridge Dilemmas",
    escape = TRUE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#Additional analysis after all exclusions
additional_res_2_excluded <- 
  trolley %>%
  filter(include_study1a | include_study1b | include_study2a | include_study2b) %>% 
  select(survey_name, survey_id, matches("trolley_[0-9]_rate|speedboat_[0-9]_rate")) %>% 
  pivot_longer(matches("_rate"), names_to = "task", names_pattern = "(.*)_rate", values_to = "rate") %>% 
  mutate(comparison = case_when(task %in% c("trolley_3", "trolley_4") ~ "trolley_standard",
                                task %in% c("speedboat_3", "speedboat_4") ~ "speedboat_standard",
                                TRUE ~ NA_character_)) %>% 
  drop_na(rate, comparison) %>% 
  nest(data = c(survey_id, task, rate)) %>% 
  mutate(bf_res = map(data, ~ ttestBF(formula = rate ~ task, data = .x, rscale=0.26)),
         bf = map_dbl(bf_res, ~ round(my_bf_extractor(.x)$bf, 2)),
         freq_res = map(data, ~ t.test(rate ~ task, data = .x,  paired = FALSE) %>% broom::tidy()),
         t = map_dbl(freq_res, ~ round(.x$statistic, 2)),
         p = map_dbl(freq_res, ~ round(.x$p.value, 2)),
         df = map_dbl(freq_res, ~ round(.x$parameter, 2)))

additional_res_2_excluded %>% 
  filter(str_detect(comparison, "standard")) %>% 
  separate(comparison, into = c("Dilemma", "Comparison"), sep = "_") %>% 
  transmute(Cluster = str_remove(survey_name, "^[^_]*_"),
            Dilemma = str_to_title(Dilemma),
            t,
            `Bf` = scales::scientific(bf),
            df,
            p = as.character(p),
            p = if_else(as.numeric(p) < .001, "< .001", p)) %>% 
  papaja::apa_table(
    caption = "Comparing the Standard Switch and Standard Footbridge Dilemmas",
    escape = TRUE)
```

## Oxford utilitarianism Scale

As we registered, we simply publish descriptive statistics of the Oxford Utilitarianism Scale in each cultural clusters.

```{r, echo = FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Prepare data for plotting
plot_data <-
  trolley %>%
  filter(include_noproblem) %>% 
  select(survey_name, lab, ResponseId, contains("oxford_")) %>%
  pivot_longer(
    contains("oxford_"),
    names_to = "item_no",
    values_to = "rate",
    names_prefix = "oxford_utilitarian_") %>%
  mutate(item_no = as.integer(item_no),
         subscale = case_when(item_no == 1L ~ "Impartial Beneficence",
                              item_no == 2L ~ "Instrumental Harm",
                              item_no == 3L ~ "Impartial Beneficence",
                              item_no == 4L ~ "Instrumental Harm",
                              item_no == 5L ~ "Impartial Beneficence",
                              item_no == 6L ~ "Instrumental Harm",
                              item_no == 7L ~ "Impartial Beneficence",
                              item_no == 8L ~ "Instrumental Harm",
                              item_no == 9L ~ "Impartial Beneficence",
                              TRUE ~ NA_character_),
         survey_name = str_remove(survey_name, "PSA006_")) %>% 
  drop_na(rate)

# Create plot
plot_data %>% 
  ggplot() +
  aes(
    x = subscale,
    y = rate,
    width = 0.7) +
  geom_boxplot() +
  facet_wrap(facets = vars(survey_name)) +
  labs(
    y = "Rating",
    x = "Subscale") +
  scale_y_continuous(
    breaks = 1:7,
    labels = as.character(1:7)) + 
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.title = element_text(hjust = 0.5, vjust = 0.5, face = "bold", size = 17),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = 10),
    axis.text.x = element_text(face = "bold", size = 7, colour = "Black"),
    axis.text.y = element_text(face = "bold", size = 12, colour = "Black"),
    legend.title = element_blank(),
    legend.text = element_text(size = 9))
```
